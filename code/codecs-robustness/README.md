## Основная ветка бенчмарка устойчивости кодеков/JPEGAI
Запускать можно через Gitlab CI/CD или вручную в SLURM. Ниже инструкция по запуску в SLURM. #TODO: актуализировать.
### Как запускать задачи в slurm 
Перед запуском убедитесь, что на сервере актуальная версия репозитория: 
```
cd ~/users/26k_ abu/framework/code/metrics/
git pull
```
Проверьте, какой сейчас установлен лосс: это можно сделать, например, через 
```cat ./attacks/utils/codec_losses.py``` 
в папке metrics и посмотрев, какое название в переменной codec_loss_name. Если хотите другой лосс, надо сделать коммит в репозиторий с соответствующим изменением этой переменной и заново сделать `git pull`.
Задачи для jpegai кодеков и прочих запускаются разными скриптами и в разных образах. Для jpegai используется скрипт `~/users/26k_abu/framework/scripts/launch_framework_job_jpegai_v2.sh`, для остальных `launch_framework_job_v3.sh` там же.
При запуске скрипты читают список кодеков и атак из файлов `~/users/26k_abu/framework/launches/codecs.txt` и `attacks.txt`. ВАЖНО: при запуске скрипта на подсчет через sbatch, чтение этих файлов происходит в момент постановки задачи на подсчет системой - это значит, что если вы запустили скрипт с одним содержимым txt файлов, после чего модифицировали их ДО постановки на подсчет, то скрипт будет использовать обновленные файлы. Проверить, поставилась ли задача на подсчет, можно через `squeue -u imolodetskikh` — если поставилась, у джобы с соответствующим номером будет статус «R». 

Итого, последовательность действий следующая:
1. зайти на slurm-master: `ssh imolodetskikh@10.36.60.202`
2. Открыть свой tmux терминал (`tmux attach -t *ваш терминал*` или `tmux new -s *название*`)
3. Актуализировать репозиторий через `git pull` (описано выше)
4. `cd ~/users/26k_abu/framework/launches/`
5. Внести в список кодеков `codecs.txt` необходимые кодеки. ВАЖНО: вносите либо все jpegai кодеки (16 штук), либо все прочие (47 штук). Одновременно и то и то вносить не надо - потому что запускаете задачи скриптом, который предназначен либо только для jpegai, либо для прочего. Также важно: если вы будете редактировать файл удаленно с windows компьютера, убедитесь, что у вас включен LF режим, а не CRLF, иначе из за лишних символов на конце строки ничего работать не будет.
6. Внести в список `attacks.txt` названия атак, аналогично как со списком кодеков. Я обычно вношу туда 1 атаку, запускаю, потом вношу следующую, запускаю и тд. Таким образом, в каждой задаче будет считаться 1 атака на всем списке кодеков, и для нее достаточно будет запросить 2-3 ноды. Но можно в принципе и много атак сразу вписать, тогда не надо будет делать несколько запусков, но нужно будет запросить побольше нод (но не более 10). Каждая нода параллельно обрабатывает 8 кодеко-атак (те всего параллельно будет обрабатываться 8*кол-во нод кодеко-атак), не влезшие задачи ставятся в очередь.
7. Запустить подсчет: `sbatch --nodes *кол во нод* ~/users/26k_abu/framework/scripts/*название скрипта* *название лосса*` ; Название запускаемого скрипта зависит от того, какие кодеки запускаете (jpegai/прочие, см. выше). Название лосса должно совпадать с тем, которое указано в репозитории (`~/users/26k_ abu/framework/code/metrics/attacks/utils/codec_losses.py`)
8. Sbatch при запуске выведет номер джобы. Перед какими либо дальнейшими действиями убедитесь, что задача поставилась на подсчет (в `squeue -u imolodetskikh` у нее статус «R»), до этого момента не редактируйте txt файлы. НЕ редактируйте репозиторий (`git pull`’ом) пока есть работающие задачи: они в любой момент на протяжении работы могут его использовать, поэтому перед установкой следующего лосса дождитесь завершения поставленных джобов.
9. Логи поставленных задач пишутся в онлайн режиме в файл `slurm-*номер джобы*.out` . Если что то пошло не так, вы можете отменить задачу через `scancel *номер джобы*`.
